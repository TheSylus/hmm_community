import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// FIX: Create a valid i18n/index.ts module with provider, hook, and translations.

type Language = 'en' | 'de';
type Translations = Record<string, string | Record<string, any>>;

const translations: Record<Language, Translations> = {
  en: {
    'nav.dashboard': 'Dashboard',
    'nav.list': 'List',
    'nav.add': 'Add New',
    'nav.discover': 'Discover',
    'nav.filter': 'Filter',
    'header.title': 'Food Memory Tracker',
    'header.searchPlaceholder': 'Search by name, tag, notes...',
    'header.filter.type.all': 'All Types',
    'header.filter.type.products': 'Products',
    'header.filter.type.dishes': 'Dishes',
    'header.filter.all': 'All Ratings',
    'header.filter.liked': 'Liked (4+ Stars)',
    'header.filter.disliked': 'Disliked (1-2 Stars)',
    'header.sort.dateDesc': 'Date (Newest First)',
    'header.sort.dateAsc': 'Date (Oldest First)',
    'header.sort.ratingDesc': 'Rating (High to Low)',
    'header.sort.ratingAsc': 'Rating (Low to High)',
    'header.sort.nameAsc': 'Name (A-Z)',
    'header.sort.nameDesc': 'Name (Z-A)',
    'form.editTitle': 'Edit Entry',
    'form.addNewButton': 'Add New Entry',
    'form.button.scanBarcode': 'Scan Barcode',
    'form.button.scanNew': 'Scan Product',
    'form.button.takePhoto': 'Take Photo',
    'form.button.upload': 'Upload',
    'form.button.dictate': 'Dictate',
    'form.image.removeAria': 'Remove image',
    'form.placeholder.name': 'Product Name (e.g., Organic Granola)',
    'form.placeholder.dishName': 'Dish Name (e.g., Pizza Margherita)',
    'form.placeholder.restaurant': 'Restaurant Name',
    'form.placeholder.cuisine': 'Cuisine Type (e.g., Italian)',
    'form.placeholder.price': 'Price',
    'form.label.rating': 'Rating',
    'form.aria.rate': 'Rate {{star}} star',
    'form.aria.ratePlural': 'Rate {{star}} stars',
    'form.placeholder.notes': 'Notes (e.g., taste, occasion, why you liked/disliked it)',
    'form.placeholder.tags': 'Tags (comma-separated, e.g., snack, sweet, vegan)',
    'form.placeholder.purchaseLocation': 'Purchase Location (e.g., Whole Foods)',
    'form.label.nutriScore': 'Nutri-Score',
    'form.aria.selectNutriScore': 'Select Nutri-Score {{score}}',
    'form.ingredients.title': 'Ingredients & Dietary Info',
    'form.button.scanIngredients': 'Scan Ingredients from Image',
    'form.ingredients.loading': 'Analyzing ingredients...',
    'form.dietary.title': 'Dietary Flags',
    'form.dietary.lactoseFree': 'Lactose-Free',
    'form.dietary.vegan': 'Vegan',
    'form.dietary.glutenFree': 'Gluten-Free',
    'form.allergens.title': 'Allergens',
    'form.ingredients.ingredientsList': 'Ingredients',
    'form.ingredients.placeholder': 'No ingredients listed. Scan the ingredients list to add them.',
    'form.error.nameAndRating': 'Please provide a name and a rating.',
    'form.button.cancel': 'Cancel',
    'form.button.update': 'Update Entry',
    'form.button.save': 'Save Entry',
    'form.aiProgress.readingName': 'Reading product name...',
    'form.aiProgress.findingScore': 'Finding Nutri-Score...',
    'form.aiProgress.generatingTags': 'Generating smart tags...',
    'form.aiProgress.searchingDatabase': 'Cross-referencing database...',
    'form.aiProgress.locatingProduct': 'Locating product in image...',
    'form.aiProgress.complete': 'Analysis complete!',
    'form.error.genericAiError': 'AI analysis failed. Please try again or enter details manually.',
    'form.error.ingredientsAiError': 'Could not analyze ingredients. Please check the image or enter them manually.',
    'form.error.offSearchDisabled': 'Barcode scanning requires the Open Food Facts search feature to be enabled in settings.',
    'form.error.barcodeError': 'Could not find product for this barcode.',
    'form.error.findRestaurants': 'Could not find nearby restaurants.',
    'form.error.geolocationUnsupported': 'Geolocation is not supported by your browser.',
    'form.error.geolocationPermission': 'Could not get location. Please allow location access.',
    'form.findRestaurants.loading': 'Finding nearby restaurants...',
    'form.label.selectRestaurant': 'Select from nearby:',
    'form.placeholder.selectRestaurant': '-- Select a restaurant --',
    'form.button.findNearby.aria': 'Find nearby restaurants',
    'form.share.title': 'Share in Community',
    'form.share.description': 'Make this item visible to other users in the Discover feed.',
    
    'list.empty.title': 'No Entries Yet',
    'list.empty.description': 'Start by adding a new food memory!',
    'card.productTooltip': 'Product',
    'card.dishTooltip': 'Dish',
    'card.publicTooltip': 'Public - visible to community',
    'card.privateTooltip': 'Private - only visible to you',
    'card.lactoseFreeTooltip': 'Lactose-Free',
    'card.veganTooltip': 'Vegan',
    'card.glutenFreeTooltip': 'Gluten-Free',
    'card.dishAt': 'at {{restaurant}}',
    'card.shareAria': 'Share {{name}}',
    'card.editAria': 'Edit {{name}}',
    'card.deleteAria': 'Delete {{name}}',
    'card.deleteConfirm': 'Are you sure you want to delete this item?',
    
    'dashboard.welcome': 'Welcome Back!',
    'dashboard.recentlyAdded': 'Recently Added',
    'dashboard.topRated': 'Top Rated',
    'dashboard.viewAll': 'View All',
    'dashboard.empty.title': 'Your Food Diary is Empty',
    'dashboard.empty.description': 'Track your first food memory to get started.',

    'settings.title': 'Settings',
    'settings.closeAria': 'Close',
    'settings.general': 'General',
    'settings.theme.label': 'Theme',
    'settings.theme.light': 'Light',
    'settings.theme.dark': 'Dark',
    'settings.theme.system': 'System',
    'settings.language.label': 'Language',
    'settings.features': 'Features',
    'settings.features.ai.label': 'Enable AI Features',
    'settings.features.ai.description': 'Use AI to automatically extract product info from images.',
    'settings.features.barcode.label': 'Enable Barcode Scanner',
    'settings.features.barcode.description': 'Quickly add products by scanning their barcode.',
    'settings.features.off.label': 'Enable Open Food Facts Search',
    'settings.features.off.description': 'Enhance product data with information from the Open Food Facts database.',
    'settings.apiKey.title': 'Gemini API Key',
    'settings.apiKey.description': 'AI features require a Google Gemini API key. Your key is stored securely in your browser.',
    'settings.apiKeyTest.placeholder': 'Enter your API key',
    'settings.apiKeyTest.button': 'Test & Save',
    'settings.apiKeyTest.status.testing': 'Testing key...',
    'settings.apiKeyTest.status.success': 'API Key is valid and saved!',
    'settings.apiKeyTest.status.error.invalidKey.start': 'API key not valid. ',
    'settings.apiKeyTest.status.error.invalidKey.linkText': 'Get a new key here.',
    'settings.apiKeyTest.status.error.invalidKey.end': '',
    'settings.apiKeyTest.status.error.generic': 'Test failed: {{message}}',
    'settings.profile.title': 'Profile',
    'settings.profile.displayName': 'Public Display Name',
    'settings.profile.placeholder': 'Your public name',
    'settings.profile.saveButton': 'Save Name',
    'settings.profile.saving': 'Saving...',
    'settings.profile.success': 'Saved!',

    'auth.emailPlaceholder': 'Email',
    'auth.passwordPlaceholder': 'Password',
    'auth.signUp': 'Sign Up',
    'auth.signIn': 'Sign In',
    'auth.magicLinkSuccess': 'Check your email for the confirmation link!',
    'auth.toggle.signIn': 'Already have an account? Sign In',
    'auth.toggle.signUp': "Don't have an account? Sign Up",

    'discover.title': 'Discover',
    'discover.loading': 'Loading community feed...',
    'discover.empty.title': 'Nothing to discover yet',
    'discover.empty.description': 'Be the first to share a public item!',

    'shoppingList.title': 'Shopping Lists',
    'shoppingList.addAria': 'Add {{name}} to shopping list',
    'shoppingList.removeAria': 'Remove {{name}} from list',
    'shoppingList.toggleDetailsAria': 'Toggle item details',
    'shoppingList.selectListAria': 'Select a shopping list',
    'shoppingList.empty': 'This shopping list is empty.',
    'shoppingList.clear': 'Clear Checked Items',
    'shoppingList.uncategorized': 'Uncategorized',
    'shoppingList.newListButton': 'Create New List',
    'shoppingList.newListPlaceholder': 'New list name...',
    'shoppingList.createButton': 'Create',
    'shoppingList.manage.buttonTitle': 'Manage List',
    'shoppingList.delete.button': 'Delete List',
    'shoppingList.delete.confirm': 'Are you sure you want to delete the list "{{listName}}"? This cannot be undone.',
    'shoppingList.leave.button': 'Leave List',
    'shoppingList.leave.confirm': 'Are you sure you want to leave the list "{{listName}}"?',
    'shoppingList.share.inviteButton': 'Invite Members',
    'shoppingList.share.linkCopied': 'Invite link copied!',
    'shoppingList.share.copyFailed': 'Could not copy link. Please try again.',
    'shoppingList.collaboration.members': 'Members',
    'shoppingList.collaboration.you': 'You',
    'shoppingList.collaboration.someone': 'Someone',
    'shoppingList.collaboration.addedBy': 'Added by {{name}}',
    'shoppingList.collaboration.checkedBy': 'Checked by {{name}}',

    'detail.notesTitle': 'Notes',
    'detail.tagsTitle': 'Tags',
    'detail.dietaryTitle': 'Dietary Information',
    'detail.allergensTitle': 'Allergens',
    'detail.ingredientsTitle': 'Ingredients',
    'detail.status': 'Status',
    'detail.statusPublic': 'Public',
    'detail.statusPrivate': 'Private',
    'detail.commentsTitle': 'Comments',
    'detail.noComments': 'No comments yet. Be the first to share your thoughts!',
    'detail.addCommentPlaceholder': 'Add a comment...',
    'detail.sendComment': 'Send',

    'modal.shared.close': 'Close',

  },
  de: {
    'nav.dashboard': 'Dashboard',
    'nav.list': 'Liste',
    'nav.add': 'Hinzufügen',
    'nav.discover': 'Entdecken',
    'nav.filter': 'Filter',
    'header.title': 'Food Memory Tracker',
    'header.searchPlaceholder': 'Suche nach Name, Tag, Notizen...',
    'header.filter.type.all': 'Alle Arten',
    'header.filter.type.products': 'Produkte',
    'header.filter.type.dishes': 'Gerichte',
    'header.filter.all': 'Alle Bewertungen',
    'header.filter.liked': 'Positiv (4+ Sterne)',
    'header.filter.disliked': 'Negativ (1-2 Sterne)',
    'header.sort.dateDesc': 'Datum (Neueste zuerst)',
    'header.sort.dateAsc': 'Datum (Älteste zuerst)',
    'header.sort.ratingDesc': 'Bewertung (Hoch zu Niedrig)',
    'header.sort.ratingAsc': 'Bewertung (Niedrig zu Hoch)',
    'header.sort.nameAsc': 'Name (A-Z)',
    'header.sort.nameDesc': 'Name (Z-A)',
    'form.editTitle': 'Eintrag bearbeiten',
    'form.addNewButton': 'Neuen Eintrag hinzufügen',
    'form.button.scanBarcode': 'Barcode scannen',
    'form.button.scanNew': 'Produkt scannen',
    'form.button.takePhoto': 'Foto aufnehmen',
    'form.button.upload': 'Hochladen',
    'form.button.dictate': 'Diktieren',
    'form.image.removeAria': 'Bild entfernen',
    'form.placeholder.name': 'Produktname (z.B. Bio-Müsli)',
    'form.placeholder.dishName': 'Gericht (z.B. Pizza Margherita)',
    'form.placeholder.restaurant': 'Restaurantname',
    'form.placeholder.cuisine': 'Küche (z.B. Italienisch)',
    'form.placeholder.price': 'Preis',
    'form.label.rating': 'Bewertung',
    'form.aria.rate': 'Bewerte {{star}} Stern',
    'form.aria.ratePlural': 'Bewerte {{star}} Sterne',
    'form.placeholder.notes': 'Notizen (z.B. Geschmack, Anlass, warum es dir geschmeckt/nicht geschmeckt hat)',
    'form.placeholder.tags': 'Tags (kommagetrennt, z.B. Snack, süß, vegan)',
    'form.placeholder.purchaseLocation': 'Gekauft bei (z.B. Edeka)',
    'form.label.nutriScore': 'Nutri-Score',
    'form.aria.selectNutriScore': 'Wähle Nutri-Score {{score}}',
    'form.ingredients.title': 'Zutaten & Ernährungsinfo',
    'form.button.scanIngredients': 'Zutaten vom Bild scannen',
    'form.ingredients.loading': 'Analysiere Zutaten...',
    'form.dietary.title': 'Ernährungsmerkmale',
    'form.dietary.lactoseFree': 'Laktosefrei',
    'form.dietary.vegan': 'Vegan',
    'form.dietary.glutenFree': 'Glutenfrei',
    'form.allergens.title': 'Allergene',
    'form.ingredients.ingredientsList': 'Zutaten',
    'form.ingredients.placeholder': 'Keine Zutaten gelistet. Scanne die Zutatenliste, um sie hinzuzufügen.',
    'form.error.nameAndRating': 'Bitte gib einen Namen und eine Bewertung an.',
    'form.button.cancel': 'Abbrechen',
    'form.button.update': 'Eintrag aktualisieren',
    'form.button.save': 'Eintrag speichern',
    'form.aiProgress.readingName': 'Lese Produktnamen...',
    'form.aiProgress.findingScore': 'Suche Nutri-Score...',
    'form.aiProgress.generatingTags': 'Erstelle Smart-Tags...',
    'form.aiProgress.searchingDatabase': 'Gleiche mit Datenbank ab...',
    'form.aiProgress.locatingProduct': 'Finde Produkt im Bild...',
    'form.aiProgress.complete': 'Analyse abgeschlossen!',
    'form.error.genericAiError': 'KI-Analyse fehlgeschlagen. Bitte versuche es erneut oder gib die Daten manuell ein.',
    'form.error.ingredientsAiError': 'Konnte Zutaten nicht analysieren. Bitte prüfe das Bild oder gib sie manuell ein.',
    'form.error.offSearchDisabled': 'Barcode-Scannen erfordert die Aktivierung der Open Food Facts-Suche in den Einstellungen.',
    'form.error.barcodeError': 'Konnte kein Produkt für diesen Barcode finden.',
    'form.error.findRestaurants': 'Konnte keine Restaurants in der Nähe finden.',
    'form.error.geolocationUnsupported': 'Standortfreigabe wird von deinem Browser nicht unterstützt.',
    'form.error.geolocationPermission': 'Standort konnte nicht abgerufen werden. Bitte erlaube den Zugriff.',
    'form.findRestaurants.loading': 'Suche Restaurants in der Nähe...',
    'form.label.selectRestaurant': 'Aus der Nähe auswählen:',
    'form.placeholder.selectRestaurant': '-- Wähle ein Restaurant --',
    'form.button.findNearby.aria': 'Finde Restaurants in der Nähe',
    'form.share.title': 'In der Community teilen',
    'form.share.description': 'Mache diesen Eintrag für andere Nutzer im "Entdecken"-Feed sichtbar.',

    'list.empty.title': 'Noch keine Einträge',
    'list.empty.description': 'Füge deine erste Essenserinnerung hinzu!',
    'card.productTooltip': 'Produkt',
    'card.dishTooltip': 'Gericht',
    'card.publicTooltip': 'Öffentlich - für die Community sichtbar',
    'card.privateTooltip': 'Privat - nur für dich sichtbar',
    'card.lactoseFreeTooltip': 'Laktosefrei',
    'card.veganTooltip': 'Vegan',
    'card.glutenFreeTooltip': 'Glutenfrei',
    'card.dishAt': 'bei {{restaurant}}',
    'card.shareAria': 'Teile {{name}}',
    'card.editAria': 'Bearbeite {{name}}',
    'card.deleteAria': 'Lösche {{name}}',
    'card.deleteConfirm': 'Möchtest du diesen Eintrag wirklich löschen?',

    'dashboard.welcome': 'Willkommen zurück!',
    'dashboard.recentlyAdded': 'Zuletzt hinzugefügt',
    'dashboard.topRated': 'Top bewertet',
    'dashboard.viewAll': 'Alle ansehen',
    'dashboard.empty.title': 'Dein Essens-Tagebuch ist leer',
    'dashboard.empty.description': 'Füge deinen ersten Eintrag hinzu, um loszulegen.',

    'settings.title': 'Einstellungen',
    'settings.closeAria': 'Schließen',
    'settings.general': 'Allgemein',
    'settings.theme.label': 'Design',
    'settings.theme.light': 'Hell',
    'settings.theme.dark': 'Dunkel',
    'settings.theme.system': 'System',
    'settings.language.label': 'Sprache',
    'settings.features': 'Funktionen',
    'settings.features.ai.label': 'KI-Funktionen aktivieren',
    'settings.features.ai.description': 'Nutze KI, um Produktinfos automatisch aus Bildern zu extrahieren.',
    'settings.features.barcode.label': 'Barcode-Scanner aktivieren',
    'settings.features.barcode.description': 'Füge Produkte schnell durch Scannen des Barcodes hinzu.',
    'settings.features.off.label': 'Open Food Facts-Suche aktivieren',
    'settings.features.off.description': 'Erweitere Produktdaten mit Informationen aus der Open Food Facts-Datenbank.',
    'settings.apiKey.title': 'Gemini API-Schlüssel',
    'settings.apiKey.description': 'KI-Funktionen benötigen einen Google Gemini API-Schlüssel. Dein Schlüssel wird sicher in deinem Browser gespeichert.',
    'settings.apiKeyTest.placeholder': 'Gib deinen API-Schlüssel ein',
    'settings.apiKeyTest.button': 'Testen & Speichern',
    'settings.apiKeyTest.status.testing': 'Teste Schlüssel...',
    'settings.apiKeyTest.status.success': 'API-Schlüssel ist gültig und gespeichert!',
    'settings.apiKeyTest.status.error.invalidKey.start': 'API-Schlüssel ungültig. ',
    'settings.apiKeyTest.status.error.invalidKey.linkText': 'Hole hier einen neuen Schlüssel.',
    'settings.apiKeyTest.status.error.invalidKey.end': '',
    'settings.apiKeyTest.status.error.generic': 'Test fehlgeschlagen: {{message}}',
    'settings.profile.title': 'Profil',
    'settings.profile.displayName': 'Öffentlicher Anzeigename',
    'settings.profile.placeholder': 'Dein öffentlicher Name',
    'settings.profile.saveButton': 'Namen speichern',
    'settings.profile.saving': 'Speichern...',
    'settings.profile.success': 'Gespeichert!',

    'auth.emailPlaceholder': 'E-Mail',
    'auth.passwordPlaceholder': 'Passwort',
    'auth.signUp': 'Registrieren',
    'auth.signIn': 'Anmelden',
    'auth.magicLinkSuccess': 'Prüfe deine E-Mails für den Bestätigungslink!',
    'auth.toggle.signIn': 'Schon ein Konto? Anmelden',
    'auth.toggle.signUp': 'Noch kein Konto? Registrieren',
    
    'discover.title': 'Entdecken',
    'discover.loading': 'Lade Community-Feed...',
    'discover.empty.title': 'Noch nichts zu entdecken',
    'discover.empty.description': 'Sei der Erste, der einen öffentlichen Eintrag teilt!',

    'shoppingList.title': 'Einkaufslisten',
    'shoppingList.addAria': 'Füge {{name}} zur Einkaufsliste hinzu',
    'shoppingList.removeAria': 'Entferne {{name}} von der Liste',
    'shoppingList.toggleDetailsAria': 'Details ein-/ausblenden',
    'shoppingList.selectListAria': 'Wähle eine Einkaufsliste',
    'shoppingList.empty': 'Diese Einkaufsliste ist leer.',
    'shoppingList.clear': 'Abgehakte entfernen',
    'shoppingList.uncategorized': 'Unkategorisiert',
    'shoppingList.newListButton': 'Neue Liste erstellen',
    'shoppingList.newListPlaceholder': 'Name der neuen Liste...',
    'shoppingList.createButton': 'Erstellen',
    'shoppingList.manage.buttonTitle': 'Liste verwalten',
    'shoppingList.delete.button': 'Liste löschen',
    'shoppingList.delete.confirm': 'Möchtest du die Liste "{{listName}}" wirklich löschen? Dies kann nicht rückgängig gemacht werden.',
    'shoppingList.leave.button': 'Liste verlassen',
    'shoppingList.leave.confirm': 'Möchtest du die Liste "{{listName}}" wirklich verlassen?',
    'shoppingList.share.inviteButton': 'Mitglieder einladen',
    'shoppingList.share.linkCopied': 'Einladungslink kopiert!',
    'shoppingList.share.copyFailed': 'Link konnte nicht kopiert werden. Bitte versuche es erneut.',
    'shoppingList.collaboration.members': 'Mitglieder',
    'shoppingList.collaboration.you': 'Du',
    'shoppingList.collaboration.someone': 'Jemand',
    'shoppingList.collaboration.addedBy': 'Hinzugefügt von {{name}}',
    'shoppingList.collaboration.checkedBy': 'Abgehakt von {{name}}',
    
    'detail.notesTitle': 'Notizen',
    'detail.tagsTitle': 'Tags',
    'detail.dietaryTitle': 'Ernährungsinformationen',
    'detail.allergensTitle': 'Allergene',
    'detail.ingredientsTitle': 'Zutaten',
    'detail.status': 'Status',
    'detail.statusPublic': 'Öffentlich',
    'detail.statusPrivate': 'Privat',
    'detail.commentsTitle': 'Kommentare',
    'detail.noComments': 'Noch keine Kommentare. Sei der Erste, der seine Meinung teilt!',
    'detail.addCommentPlaceholder': 'Einen Kommentar hinzufügen...',
    'detail.sendComment': 'Senden',

    'modal.shared.close': 'Schließen',
  },
};

// Helper function to get a nested property from an object
const get = (obj: any, path: string, fallback: string) => {
    const keys = path.split('.');
    let result = obj;
    for (const key of keys) {
        if (result === undefined || result === null) return fallback;
        result = result[key];
    }
    return result || fallback;
};

interface I18nContextType {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (key: string, options?: Record<string, string | number>) => string;
}

const I18nContext = createContext<I18nContextType | undefined>(undefined);

export const I18nProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [language, setLanguage] = useState<Language>(() => {
    const savedLang = localStorage.getItem('language');
    // Default to English if saved language is not supported
    return (savedLang === 'de' || savedLang === 'en') ? savedLang : 'en';
  });

  useEffect(() => {
    localStorage.setItem('language', language);
  }, [language]);

  const t = (key: string, options?: Record<string, string | number>): string => {
    const langDict = translations[language] || translations.en;
    let text = get(langDict, key, key);
    if (options && typeof text === 'string') {
      Object.entries(options).forEach(([k, v]) => {
        text = text.replace(new RegExp(`{{${k}}}`, 'g'), String(v));
      });
    }
    return text;
  };

  const value = { language, setLanguage, t };

  return React.createElement(I18nContext.Provider, { value }, children);
};

export const useTranslation = (): I18nContextType => {
  const context = useContext(I18nContext);
  if (context === undefined) {
    throw new Error('useTranslation must be used within an I18nProvider');
  }
  return context;
};
