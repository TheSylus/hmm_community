import React, { createContext, useState, useEffect, useContext, ReactNode, useMemo, useCallback } from 'react';

const enTranslations = {
  "nav.myItems": "My Items",
  "nav.family": "Family",
  "header.title": "Food Memory Tracker",
  "header.searchPlaceholder": "Search by name, notes, tags...",
  "header.filter.button": "Filters",
  "header.filter.all": "All Items",
  "header.filter.liked": "Liked (4-5 Stars)",
  "header.filter.disliked": "Disliked (1-2 Stars)",
  "header.filter.type.all": "All Types",
  "header.filter.type.products": "Products",
  "header.filter.type.dishes": "Dishes",
  "header.filter.active.search": "Search: \"{term}\"",
  "header.filter.active.aiSearch": "AI: \"{term}\"",
  "header.filter.active.type.product": "Type: Products",
  "header.filter.active.type.dish": "Type: Dishes",
  "header.filter.active.rating.liked": "Liked Items",
  "header.filter.active.rating.disliked": "Disliked Items",
  "header.filter.clearAll": "Clear all",
  "header.sort.dateDesc": "Date (Newest First)",
  "header.sort.dateAsc": "Date (Oldest First)",
  "header.sort.ratingDesc": "Rating (High to Low)",
  "header.sort.ratingAsc": "Rating (Low to High)",
  "header.sort.nameAsc": "Name (A-Z)",
  "header.sort.nameDesc": "Name (Z-A)",
  "header.shoppingListAria": "Open Shopping List",
  "footer.text": "Never forget a favorite again.",
  "filterPanel.title": "Filter & Sort",
  "filterPanel.search": "Search term",
  "filterPanel.aiSearchTitle": "AI-Powered Search",
  "filterPanel.filterByType": "Filter by Type",
  "filterPanel.filterByRating": "Filter by Rating",
  "filterPanel.sortBy": "Sort by",
  "filterPanel.reset": "Reset Filters",
  "filterPanel.apply": "Apply",
  "dashboard.title": "Dashboard",
  "dashboard.welcome": "Welcome Back!",
  "dashboard.recentlyAdded": "Recently Added",
  "dashboard.topRated": "Your Top Rated",
  "dashboard.viewAll": "View All Items",
  "dashboard.empty.title": "Your culinary journey starts here!",
  "dashboard.empty.description": "Add your first product or dish to see your personal dashboard come to life.",
  "family.title": "Family Favorites",
  "family.loading": "Loading Family Favorites...",
  "family.empty.title": "No Family Favorites Yet!",
  "family.empty.description": "When you or someone in your household adds an item and marks it as a favorite, it will appear here.",
  "family.noHousehold.title": "Join a Household to see Family Favorites",
  "family.noHousehold.description": "Create or join a household in the settings to start sharing items and shopping lists with your family.",
  "conversationalSearch.placeholder": "Ask about your food... (e.g., a gluten-free snack I liked)",
  "conversationalSearch.tooltip": "Search with AI",
  "conversationalSearch.buttonAria": "Search with AI",
  "conversationalSearch.searching": "AI is thinking...",
  "conversationalSearch.error": "AI search failed. Please try a different query.",
  "conversationalSearch.resultsTitle": "AI Search Results",
  "conversationalSearch.clear": "Clear AI Search",
  "shoppingList.title": "Shared List",
  "shoppingList.empty": "This list is empty. Add products from their cards to get started.",
  "shoppingList.clear": "Clear Completed",
  "shoppingList.addAria": "Add {name} to shopping list",
  "shoppingList.removeAria": "Remove {name} from shopping list",
  "shoppingList.toggleDetailsAria": "Toggle details",
  "shoppingList.addedToast": "{name} added to list.",
  "shoppingList.uncategorized": "Uncategorized",
  "shoppingList.defaultListName": "Household Groceries",
  "shoppingList.joinSuccess": "Successfully joined household: {householdName}!",
  "shoppingList.selectListAria": "Select a shared list",
  "shoppingList.newListButton": "Create New List",
  "shoppingList.newListPlaceholder": "New list name...",
  "shoppingList.createButton": "Create",
  "shoppingList.share.inviteButton": "Invite Members",
  "shoppingList.share.linkCopied": "Invite Link Copied!",
  "shoppingList.share.copyFailed": "Could not copy link. Please copy it manually.",
  "shoppingList.collaboration.members": "Members",
  "shoppingList.collaboration.you": "You",
  "shoppingList.collaboration.someone": "Someone",
  "shoppingList.collaboration.addedBy": "Added by {name}",
  "shoppingList.collaboration.checkedBy": "Checked by {name}",
  "shoppingList.manage.buttonTitle": "Manage list",
  "shoppingList.delete.button": "Delete List",
  "shoppingList.delete.confirm": "Are you sure you want to permanently delete the list \"{listName}\"? This action cannot be undone.",
  "form.addNewButton": "Add New Item",
  "form.editTitle": "Edit Food Item",
  "form.placeholder.name": "Product Name",
  "form.placeholder.dishName": "Dish Name (e.g., Spaghetti Carbonara)",
  "form.placeholder.restaurant": "Restaurant Name",
  "form.placeholder.cuisine": "Cuisine Type (e.g., Italian)",
  "form.placeholder.price": "Price",
  "form.placeholder.purchaseLocation": "Store / Location (e.g., Lidl)",
  "form.label.rating": "Rating:",
  "form.aria.rate": "Rate {star} star",
  "form.aria.ratePlural": "Rate {star} stars",
  "form.placeholder.notes": "Notes (e.g., taste, where you bought it)",
  "form.placeholder.tags": "Tags (comma, separated)",
  "form.label.nutriScore": "Nutri-Score:",
  "form.aria.selectNutriScore": "Select Nutri-Score {score}",
  "form.label.selectRestaurant": "Or select a nearby restaurant:",
  "form.placeholder.selectRestaurant": "-- Select a restaurant --",
  "form.error.nameAndRating": "Please provide a name and a rating.",
  "form.error.genericAiError": "Could not analyze image with AI. Please try again or enter details manually.",
  "form.error.ingredientsAiError": "Could not analyze ingredients list.",
  "form.error.barcodeError": "Could not fetch product data for this barcode. The product may not be in the Open Food Facts database.",
  "form.error.offSearchDisabled": "Food Database Search is disabled in settings. You can enable it to use this feature.",
  "form.error.geolocationUnsupported": "Geolocation is not supported by your browser.",
  "form.error.geolocationPermission": "Could not get location. Please enable location services and grant permission.",
  "form.error.findRestaurants": "Could not find nearby restaurants. Please try again or enter manually.",
  "form.button.cancel": "Cancel",
  "form.button.save": "Save Item",
  "form.button.update": "Update Item",
  "form.button.scanIngredients": "Scan Ingredients",
  "form.button.scanBarcode": "Scan Barcode",
  "form.button.dictate": "Dictate",
  "form.button.takePhoto": "Take Photo",
  "form.button.findNearby.aria": "Find nearby restaurants",
  "form.findRestaurants.loading": "Finding nearby restaurants...",
  "form.image.removeAria": "Remove image",
  "form.image.placeholder": "Scan a product or upload an image to start",
  "form.button.scanNew": "Scan Photo",
  "form.button.upload": "Upload",
  "form.aiProgress.readingName": "Reading product name...",
  "form.aiProgress.findingScore": "Finding Nutri-Score...",
  "form.aiProgress.generatingTags": "Generating descriptive tags...",
  "form.aiProgress.searchingDatabase": "Searching database for extra info...",
  "form.aiProgress.locatingProduct": "Locating product in image...",
  "form.aiProgress.complete": "Analysis Complete!",
  "form.ingredients.title": "Ingredients & Dietary Info",
  "form.ingredients.loading": "Scanning ingredients list...",
  "form.ingredients.ingredientsList": "Ingredients",
  "form.ingredients.placeholder": "No ingredients found. Scan the barcode or ingredients list to add them.",
  "form.allergens.title": "Allergens",
  "form.dietary.title": "Dietary Information",
  "form.dietary.lactoseFree": "Lactose-Free",
  "form.dietary.vegan": "Vegan",
  "form.dietary.glutenFree": "Gluten-Free",
  "form.familyFavorite.title": "Mark as Family Favorite",
  "form.familyFavorite.description": "Makes this item visible to everyone in your household.",
  "list.empty.title": "Your list is empty!",
  "list.empty.description": "Add a food item using the form above to start tracking your preferences.",
  "list.resultsFor": "Results for \"{searchTerm}\"",
  "card.deleteAria": "Delete {name}",
  "card.editAria": "Edit {name}",
  "card.shareAria": "Share {name}",
  "card.lactoseFreeTooltip": "Lactose-Free",
  "card.veganTooltip": "Vegan",
  "card.glutenFreeTooltip": "Gluten-Free",
  "card.productTooltip": "Packaged Product",
  "card.dishTooltip": "Restaurant Dish",
  "card.familyFavoriteTooltip": "Family Favorite",
  "card.privateTooltip": "Private Item",
  "card.dishAt": "at {restaurant}",
  "share.title": "Check out this product: {name}",
  "share.text": "I gave \"{name}\" a {rating}/5 star rating. See my thoughts on the Food Memory Tracker app!",
  "share.text_unrated": "Check out \"{name}\" on the Food Memory Tracker app!",
  "camera.title": "Take a Picture",
  "camera.error": "Could not access the camera. Please check permissions and try again.",
  "camera.error.permission": "Camera access was denied. Please check your browser and system settings to grant permission.",
  "camera.captureButton": "Capture Photo",
  "barcodeScanner.title": "Scan Barcode",
  "barcodeScanner.description": "Point your camera at the product's barcode.",
  "barcodeScanner.error.permission": "Camera access was denied. Please allow camera access in your browser settings.",
  "cropper.title": "Adjust Crop",
  "cropper.description": "Adjust the selection proposed by the AI or cancel to use the full image.",
  "cropper.button.cancel": "Cancel (Use Full)",
  "cropper.button.confirm": "Confirm Crop",
  "modal.image.closeAria": "Close image view",
  "modal.duplicate.title": "Potential Duplicate Found",
  "modal.duplicate.description": "An item named \"{itemName}\" already exists. Please review the item(s) below.",
  "modal.duplicate.button.goBack": "Go Back & Edit",
  "modal.duplicate.button.addAnyway": "Add Anyway",
  "modal.shared.title": "Shared Food Item",
  "modal.shared.description": "Someone shared this item with you. Would you like to add it to your list?",
  "modal.shared.addToList": "Add to My List",
  "modal.shared.close": "Close",
  "modal.shared.summaryNotice": "Note: This is a summary. Some details like notes, ingredients, or allergens may not be included in the share.",
  "modal.itemType.title": "What are you adding?",
  "modal.itemType.product": "Packaged Product",
  "modal.itemType.dish": "Restaurant Dish",
  "speechModal.title": "Dictate Name",
  "speechModal.description": "Start speaking, and the name will be transcribed.",
  "speechModal.listening": "Listening...",
  "settings.title": "Settings",
  "settings.closeAria": "Close settings",
  "settings.theme.title": "Theme",
  "settings.theme.light": "Light",
  "settings.theme.dark": "Dark",
  "settings.theme.system": "System",
  "settings.language.title": "Language",
  "settings.ai.title": "AI Features",
  "settings.ai.description": "Enable AI analysis to auto-fill details from photos.",
  "settings.barcodeScanner.title": "Barcode Scanner",
  "settings.barcodeScanner.description": "Enable the barcode scanner feature to look up products.",
  "settings.offSearch.title": "Food Database Search",
  "settings.offSearch.description": "Enable automatic search for product info in the Open Food Facts database.",
  "settings.button.done": "Done",
  "settings.session.title": "Account",
  "settings.session.loggedInAs": "Logged in as:",
  "settings.session.logout": "Logout",
  "settings.household.title": "Household",
  "settings.household.create.button": "Create Household",
  "settings.household.create.placeholder": "Household Name (e.g., Smith Family)",
  "settings.household.join.description": "Ask a household member for an invite link.",
  "settings.household.manage.members": "Members",
  "settings.household.manage.invite": "Invite Members",
  "settings.household.manage.leave": "Leave Household",
  "settings.household.manage.leaveConfirm": "Are you sure you want to leave this household?",
  "settings.household.manage.delete": "Delete Household",
  "settings.household.manage.deleteConfirm": "Are you sure? This will delete the household and all shared data for everyone. This cannot be undone.",
  "settings.household.manage.linkCopied": "Invite link copied to clipboard!",
  "household.error.rls": "Permission Denied: Could not update user profile after creating household. Please check your Row Level Security (RLS) policies on the 'profiles' table to ensure users can update their own 'household_id', or ensure your 'create_household' database function runs with elevated privileges (SECURITY DEFINER).",
  "household.error.generic": "Error creating household: {message}",
  "auth.emailPlaceholder": "Email",
  "auth.passwordPlaceholder": "Password",
  "auth.signIn": "Sign In",
  "auth.signUp": "Sign Up",
  "auth.magicLink": "Send Magic Link",
  "auth.magicLinkSuccess": "Check your email for the login link!",
  "auth.toggle.signUp": "Don't have an account? Sign Up",
  "auth.toggle.signIn": "Already have an account? Sign In",
  "auth.error.generic": "Authentication failed. Please try again.",
  "allergen.gluten": "Contains Gluten",
  "allergen.dairy": "Contains Dairy",
  "allergen.peanuts": "Contains Peanuts",
  "allergen.tree_nuts": "Contains Tree Nuts",
  "allergen.soy": "Contains Soy",
  "allergen.eggs": "Contains Eggs",
  "allergen.fish": "Contains Fish",
  "allergen.shellfish": "Contains Shellfish",
  "detail.notesTitle": "Notes",
  "detail.tagsTitle": "Tags",
  "detail.ingredientsTitle": "Ingredients",
  "detail.allergensTitle": "Allergens",
  "detail.dietaryTitle": "Dietary Information",
  "detail.status": "Status",
  "detail.statusFamilyFavorite": "Family Favorite",
  "detail.statusPrivate": "Private",
  "offline.message": "You are currently offline. Changes will be saved and synced when you reconnect.",
  "offline.syncComplete": "Back online! Your data has been synced."
};

const deTranslations = {
  "nav.myItems": "Meine Einträge",
  "nav.family": "Familie",
  "header.title": "Lebensmittel-Tracker",
  "header.searchPlaceholder": "Suche nach Name, Notizen, Tags...",
  "header.filter.button": "Filter",
  "header.filter.all": "Alle Produkte",
  "header.filter.liked": "Gemocht (4-5 Sterne)",
  "header.filter.disliked": "Nicht gemocht (1-2 Sterne)",
  "header.filter.type.all": "Alle Arten",
  "header.filter.type.products": "Produkte",
  "header.filter.type.dishes": "Gerichte",
  "header.filter.active.search": "Suche: \"{term}\"",
  "header.filter.active.aiSearch": "KI: \"{term}\"",
  "header.filter.active.type.product": "Art: Produkte",
  "header.filter.active.type.dish": "Art: Gerichte",
  "header.filter.active.rating.liked": "Gemochte Artikel",
  "header.filter.active.rating.disliked": "Nicht gemochte Artikel",
  "header.filter.clearAll": "Alle Filter löschen",
  "header.sort.dateDesc": "Datum (Neueste zuerst)",
  "header.sort.dateAsc": "Datum (Älteste zuerst)",
  "header.sort.ratingDesc": "Bewertung (Hoch > Niedrig)",
  "header.sort.ratingAsc": "Bewertung (Niedrig > Hoch)",
  "header.sort.nameAsc": "Name (A-Z)",
  "header.sort.nameDesc": "Name (Z-A)",
  "header.shoppingListAria": "Einkaufsliste öffnen",
  "footer.text": "Vergiss nie wieder ein Lieblingsprodukt.",
  "filterPanel.title": "Filtern & Sortieren",
  "filterPanel.search": "Suchbegriff",
  "filterPanel.aiSearchTitle": "KI-gestützte Suche",
  "filterPanel.filterByType": "Nach Typ filtern",
  "filterPanel.filterByRating": "Nach Bewertung filtern",
  "filterPanel.sortBy": "Sortieren nach",
  "filterPanel.reset": "Filter zurücksetzen",
  "filterPanel.apply": "Anwenden",
  "dashboard.title": "Dashboard",
  "dashboard.welcome": "Willkommen zurück!",
  "dashboard.recentlyAdded": "Zuletzt hinzugefügt",
  "dashboard.topRated": "Deine Top-Bewertungen",
  "dashboard.viewAll": "Alle Produkte anzeigen",
  "dashboard.empty.title": "Deine kulinarische Reise beginnt hier!",
  "dashboard.empty.description": "Füge dein erstes Produkt oder Gericht hinzu, um dein persönliches Dashboard zum Leben zu erwecken.",
  "family.title": "Familienfavoriten",
  "family.loading": "Lade Familienfavoriten...",
  "family.empty.title": "Noch keine Familienfavoriten!",
  "family.empty.description": "Wenn du oder jemand in deinem Haushalt einen Artikel als Favorit markiert, erscheint er hier.",
  "family.noHousehold.title": "Tritt einem Haushalt bei, um Favoriten zu sehen",
  "family.noHousehold.description": "Erstelle oder trete einem Haushalt in den Einstellungen bei, um Artikel und Einkaufslisten mit deiner Familie zu teilen.",
  "conversationalSearch.placeholder": "Frage nach deinem Essen... (z.B. ein glutenfreier Snack, den ich mochte)",
  "conversationalSearch.tooltip": "Mit KI suchen",
  "conversationalSearch.buttonAria": "Mit KI suchen",
  "conversationalSearch.searching": "KI denkt nach...",
  "conversationalSearch.error": "KI-Suche fehlgeschlagen. Bitte versuche eine andere Anfrage.",
  "conversationalSearch.resultsTitle": "KI-Suchergebnisse",
  "conversationalSearch.clear": "KI-Suche löschen",
  "shoppingList.title": "Gemeinsame Liste",
  "shoppingList.empty": "Diese Liste ist leer. Füge Produkte von ihren Karten hinzu, um zu beginnen.",
  "shoppingList.clear": "Erledigte entfernen",
  "shoppingList.addAria": "{name} zur Einkaufsliste hinzufügen",
  "shoppingList.removeAria": "{name} von der Einkaufsliste entfernen",
  "shoppingList.toggleDetailsAria": "Details ein-/ausblenden",
  "shoppingList.addedToast": "{name} zur Liste hinzugefügt.",
  "shoppingList.uncategorized": "Unkategorisiert",
  "shoppingList.defaultListName": "Haushaltseinkauf",
  "shoppingList.joinSuccess": "Erfolgreich dem Haushalt beigetreten: {householdName}!",
  "shoppingList.selectListAria": "Gemeinsame Liste auswählen",
  "shoppingList.newListButton": "Neue Liste erstellen",
  "shoppingList.newListPlaceholder": "Name der neuen Liste...",
  "shoppingList.createButton": "Erstellen",
  "shoppingList.share.inviteButton": "Mitglieder einladen",
  "shoppingList.share.linkCopied": "Einladungslink kopiert!",
  "shoppingList.share.copyFailed": "Link konnte nicht kopiert werden. Bitte manuell kopieren.",
  "shoppingList.collaboration.members": "Mitglieder",
  "shoppingList.collaboration.you": "Du",
  "shoppingList.collaboration.someone": "Jemand",
  "shoppingList.collaboration.addedBy": "{name} hat's hinzugefügt",
  "shoppingList.collaboration.checkedBy": "{name} hat's abgehakt",
  "shoppingList.manage.buttonTitle": "Liste verwalten",
  "shoppingList.delete.button": "Liste löschen",
  "shoppingList.delete.confirm": "Bist du sicher, dass du die Liste \"{listName}\" dauerhaft löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden.",
  "form.addNewButton": "Neuen Eintrag hinzufügen",
  "form.editTitle": "Lebensmittel bearbeiten",
  "form.placeholder.name": "Produktname",
  "form.placeholder.dishName": "Name des Gerichts (z.B. Spaghetti Carbonara)",
  "form.placeholder.restaurant": "Restaurantname",
  "form.placeholder.cuisine": "Küche (z.B. Italienisch)",
  "form.placeholder.price": "Preis",
  "form.placeholder.purchaseLocation": "Geschäft / Ort (z.B. Lidl)",
  "form.label.rating": "Bewertung:",
  "form.aria.rate": "Bewerte {star} Stern",
  "form.aria.ratePlural": "Bewerte {star} Sterne",
  "form.placeholder.notes": "Notizen (z.B. Geschmack, wo gekauft)",
  "form.placeholder.tags": "Tags (mit Komma getrennt)",
  "form.label.nutriScore": "Nutri-Score:",
  "form.aria.selectNutriScore": "Nutri-Score {score} auswählen",
  "form.label.selectRestaurant": "Oder wählen Sie ein Restaurant in der Nähe:",
  "form.placeholder.selectRestaurant": "-- Restaurant auswählen --",
  "form.error.nameAndRating": "Bitte gib einen Namen und eine Bewertung an.",
  "form.error.genericAiError": "Bild konnte nicht mit KI analysiert werden. Bitte versuchen Sie es erneut oder geben Sie die Details manuell ein.",
  "form.error.ingredientsAiError": "Zutatenliste konnte nicht mit KI analysiert werden.",
  "form.error.barcodeError": "Produktdaten für diesen Barcode konnten nicht abgerufen werden. Das Produkt ist möglicherweise nicht in der Open Food Facts-Datenbank.",
  "form.error.offSearchDisabled": "Die Lebensmittel-Datenbanksuche ist in den Einstellungen deaktiviert. Sie können sie aktivieren, um diese Funktion zu nutzen.",
  "form.error.geolocationUnsupported": "Geolokalisierung wird von Ihrem Browser nicht unterstützt.",
  "form.error.geolocationPermission": "Standort konnte nicht abgerufen werden. Bitte aktivieren Sie die Ortungsdienste und erteilen Sie die Erlaubnis.",
  "form.error.findRestaurants": "Konnte keine Restaurants in der Nähe finden. Bitte versuchen Sie es erneut oder geben Sie den Namen manuell ein.",
  "form.button.cancel": "Abbrechen",
  "form.button.save": "Produkt speichern",
  "form.button.update": "Produkt aktualisieren",
  "form.button.scanIngredients": "Zutaten scannen",
  "form.button.scanBarcode": "Barcode scannen",
  "form.button.dictate": "Diktieren",
  "form.button.takePhoto": "Foto aufnehmen",
  "form.button.findNearby.aria": "Restaurants in der Nähe finden",
  "form.findRestaurants.loading": "Suche Restaurants in der Nähe...",
  "form.image.removeAria": "Bild entfernen",
  "form.image.placeholder": "Scanne ein Produkt oder lade ein Bild hoch, um zu beginnen",
  "form.button.scanNew": "Foto scannen",
  "form.button.upload": "Hochladen",
  "form.aiProgress.readingName": "Lese Produktnamen...",
  "form.aiProgress.findingScore": "Suche nach Nutri-Score...",
  "form.aiProgress.generatingTags": "Generiere passende Tags...",
  "form.aiProgress.searchingDatabase": "Suche in Datenbank nach Zusatzinfos...",
  "form.aiProgress.locatingProduct": "Lokalisiere Produkt im Bild...",
  "form.aiProgress.complete": "Analyse abgeschlossen!",
  "form.ingredients.title": "Zutaten & Ernährungsinfo",
  "form.ingredients.loading": "Zutatenliste wird gescannt...",
  "form.ingredients.ingredientsList": "Zutaten",
  "form.ingredients.placeholder": "Keine Zutaten gefunden. Scanne den Barcode oder die Zutatenliste, um sie hinzuzufügen.",
  "form.allergens.title": "Allergene",
  "form.dietary.title": "Ernährungsinformation",
  "form.dietary.lactoseFree": "Laktosefrei",
  "form.dietary.vegan": "Vegan",
  "form.dietary.glutenFree": "Glutenfrei",
  "form.familyFavorite.title": "Als Familienfavorit markieren",
  "form.familyFavorite.description": "Macht diesen Eintrag für alle im Haushalt sichtbar.",
  "list.empty.title": "Deine Liste ist leer!",
  "list.empty.description": "Füge ein Lebensmittel über das obige Formular hinzu, um deine Vorlieben zu speichern.",
  "list.resultsFor": "Ergebnisse für \"{searchTerm}\"",
  "card.deleteAria": "Lösche {name}",
  "card.editAria": "Bearbeite {name}",
  "card.shareAria": "Teile {name}",
  "card.lactoseFreeTooltip": "Laktosefrei",
  "card.veganTooltip": "Vegan",
  "card.glutenFreeTooltip": "Glutenfrei",
  "card.productTooltip": "Verpacktes Produkt",
  "card.dishTooltip": "Restaurantgericht",
  "card.familyFavoriteTooltip": "Familienfavorit",
  "card.privateTooltip": "Privater Eintrag",
  "card.dishAt": "bei {restaurant}",
  "share.title": "Schau dir dieses Produkt an: {name}",
  "share.text": "Ich habe \"{name}\" mit {rating}/5 Sternen bewertet. Sieh dir meine Meinung in der Lebensmittel-Tracker App an!",
  "share.text_unrated": "Schau dir \"{name}\" in der Lebensmittel-Tracker App an!",
  "camera.title": "Foto aufnehmen",
  "camera.error": "Konnte nicht auf die Kamera zugreifen. Bitte überprüfe die Berechtigungen und versuche es erneut.",
  "camera.error.permission": "Der Kamerazugriff wurde verweigert. Bitte überprüfen Sie Ihre Browser- und Systemeinstellungen, um die Erlaubnis zu erteilen.",
  "camera.captureButton": "Foto aufnehmen",
  "barcodeScanner.title": "Barcode scannen",
  "barcodeScanner.description": "Richte deine Kamera auf den Barcode des Produkts.",
  "barcodeScanner.error.permission": "Kamerazugriff verweigert. Bitte erlauben Sie den Kamerazugriff in Ihren Browsereinstellungen.",
  "cropper.title": "Zuschnitt anpassen",
  "cropper.description": "Passe die von der KI vorgeschlagene Auswahl an oder brich ab, um das ganze Bild zu verwenden.",
  "cropper.button.cancel": "Abbrechen (Ganzes Bild)",
  "cropper.button.confirm": "Zuschnitt bestätigen",
  "modal.image.closeAria": "Bildansicht schließen",
  "modal.duplicate.title": "Mögliches Duplikat gefunden",
  "modal.duplicate.description": "Ein Produkt mit dem Namen \"{itemName}\" existiert bereits. Bitte überprüfe die unten stehenden Produkte.",
  "modal.duplicate.button.goBack": "Zurück & Bearbeiten",
  "modal.duplicate.button.addAnyway": "Trotzdem hinzufügen",
  "modal.shared.title": "Geteiltes Lebensmittel",
  "modal.shared.description": "Jemand hat diesen Artikel mit dir geteilt. Möchtest du ihn zu deiner Liste hinzufügen?",
  "modal.shared.addToList": "Zu meiner Liste hinzufügen",
  "modal.shared.close": "Schließen",
  "modal.shared.summaryNotice": "Hinweis: Dies ist eine Zusammenfassung. Einige Details wie Notizen, Zutaten oder Allergene sind möglicherweise nicht im geteilten Inhalt enthalten.",
  "modal.itemType.title": "Was fügst du hinzu?",
  "modal.itemType.product": "Verpacktes Produkt",
  "modal.itemType.dish": "Restaurantgericht",
  "speechModal.title": "Name diktieren",
  "speechModal.description": "Sprechen Sie einfach, und der Name wird transkribiert.",
  "speechModal.listening": "Höre zu...",
  "settings.title": "Einstellungen",
  "settings.closeAria": "Einstellungen schließen",
  "settings.theme.title": "Design",
  "settings.theme.light": "Hell",
  "settings.theme.dark": "Dunkel",
  "settings.theme.system": "System",
  "settings.language.title": "Sprache",
  "settings.ai.title": "KI-Funktionen",
  "settings.ai.description": "Aktiviere die KI-Analyse, um Details automatisch aus Fotos auszufüllen.",
  "settings.barcodeScanner.title": "Barcode-Scanner",
  "settings.barcodeScanner.description": "Aktiviere die Barcode-Scanner-Funktion, um Produkte nachzuschlagen.",
  "settings.offSearch.title": "Lebensmittel-Datenbanksuche",
  "settings.offSearch.description": "Automatische Suche nach Produktinformationen in der Open Food Facts-Datenbank aktivieren.",
  "settings.button.done": "Fertig",
  "settings.session.title": "Konto",
  "settings.session.loggedInAs": "Eingeloggt als:",
  "settings.session.logout": "Ausloggen",
  "settings.household.title": "Haushalt",
  "settings.household.create.button": "Haushalt erstellen",
  "settings.household.create.placeholder": "Haushaltsname (z.B. Familie Schmidt)",
  "settings.household.join.description": "Bitte ein Haushaltsmitglied um einen Einladungslink.",
  "settings.household.manage.members": "Mitglieder",
  "settings.household.manage.invite": "Mitglieder einladen",
  "settings.household.manage.leave": "Haushalt verlassen",
  "settings.household.manage.leaveConfirm": "Möchtest du diesen Haushalt wirklich verlassen?",
  "settings.household.manage.delete": "Haushalt löschen",
  "settings.household.manage.deleteConfirm": "Bist du sicher? Dies löscht den Haushalt und alle geteilten Daten für alle Mitglieder. Dies kann nicht rückgängig gemacht werden.",
  "settings.household.manage.linkCopied": "Einladungslink in die Zwischenablage kopiert!",
  "household.error.rls": "Zugriff verweigert: Das Benutzerprofil konnte nach dem Erstellen des Haushalts nicht aktualisiert werden. Bitte überprüfen Sie Ihre Row-Level-Security (RLS) Richtlinien für die 'profiles'-Tabelle, um sicherzustellen, dass Benutzer ihre eigene 'household_id' aktualisieren können, oder stellen Sie sicher, dass Ihre 'create_household' Datenbankfunktion mit erhöhten Rechten (SECURITY DEFINER) ausgeführt wird.",
  "household.error.generic": "Fehler beim Erstellen des Haushalts: {message}",
  "auth.emailPlaceholder": "E-Mail",
  "auth.passwordPlaceholder": "Passwort",
  "auth.signIn": "Anmelden",
  "auth.signUp": "Registrieren",
  "auth.magicLink": "Magic-Link senden",
  "auth.magicLinkSuccess": "Überprüfe deine E-Mails für den Anmelde-Link!",
  "auth.toggle.signUp": "Noch kein Konto? Registrieren",
  "auth.toggle.signIn": "Bereits ein Konto? Anmelden",
  "auth.error.generic": "Authentifizierung fehlgeschlagen. Bitte versuche es erneut.",
  "allergen.gluten": "Enthält Gluten",
  "allergen.dairy": "Enthält Milchprodukte",
  "allergen.peanuts": "Enthält Erdnüsse",
  "allergen.tree_nuts": "Enthält Schalenfrüchte",
  "allergen.soy": "Enthält Soja",
  "allergen.eggs": "Enthält Eier",
  "allergen.fish": "Enthält Fisch",
  "allergen.shellfish": "Enthält Schalentiere",
  "detail.notesTitle": "Notizen",
  "detail.tagsTitle": "Tags",
  "detail.ingredientsTitle": "Zutaten",
  "detail.allergensTitle": "Allergene",
  "detail.dietaryTitle": "Ernährungsinformation",
  "detail.status": "Status",
  "detail.statusFamilyFavorite": "Familienfavorit",
  "detail.statusPrivate": "Privat",
  "offline.message": "Sie sind derzeit offline. Änderungen werden gespeichert und synchronisiert, wenn Sie wieder online sind.",
  "offline.syncComplete": "Wieder online! Deine Daten wurden synchronisiert."
};

// Type for the translation function
type TFunction = (key: string, options?: Record<string, string | number>) => string;

// Define the context shape
interface I18nContextType {
  t: TFunction;
  setLanguage: (lang: 'en' | 'de') => void;
  language: 'en' | 'de';
}

const I18nContext = createContext<I18nContextType | undefined>(undefined);

const translationsData: Record<'en' | 'de', Record<string, string>> = {
  en: enTranslations,
  de: deTranslations,
};

const getInitialLocale = (): 'en' | 'de' => {
  const browserLang = navigator.language.split('-')[0];
  if (browserLang in translationsData) {
    return browserLang as 'en' | 'de';
  }
  return 'en';
};

export const I18nProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [language, setLanguage] = useState<'en' | 'de'>(() => {
    const savedLang = localStorage.getItem('language');
    if (savedLang === 'en' || savedLang === 'de') {
      return savedLang;
    }
    return getInitialLocale();
  });

  const t: TFunction = useCallback((key, options) => {
    const translationSet = translationsData[language];
    let translation = translationSet[key] || key;
    if (options) {
      Object.keys(options).forEach(optionKey => {
        translation = translation.replace(`{${optionKey}}`, String(options[optionKey]));
      });
    }
    return translation;
  }, [language]);
  
  const handleSetLanguage = useCallback((lang: 'en' | 'de') => {
      setLanguage(lang);
      localStorage.setItem('language', lang);
  }, []);

  useEffect(() => {
      document.documentElement.lang = language;
  }, [language]);

  const value = useMemo(() => ({ t, setLanguage: handleSetLanguage, language }), [t, handleSetLanguage, language]);

  return React.createElement(I18nContext.Provider, { value }, children);
};

export const useTranslation = (): I18nContextType => {
  const context = useContext(I18nContext);
  if (context === undefined) {
    throw new Error('useTranslation must be used within an I18nProvider');
  }
  return context;
};